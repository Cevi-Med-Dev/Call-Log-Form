<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./assets/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="icon" type="image/x-icon" href="./assets/img/icon.svg
    ">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
  <title>CeviMed Customer Service Form</title>
</head>

<body>
  <section class="leftColumn">
    <img src="./assets/img/column.jpg" alt="">
  </section>
  <section id="formContainer">
    <img id="logo" src="./assets/img/logo.png" alt="">
    <form target="_blank"
      action="https://hooks.airtable.com/workflows/v1/genericWebhook/app7xwRPHHOaWI4pJ/wflyLNHGL2T8dEnQs/wtrlCTYJiBKLmDcAZ"
      method="post" onkeydown="(event.keyCode === 13) && false">
      <section id="fields">
        <section id="flags" class="animate__animated animate__bounceInLeft">

          <div>

            <select class="input" id="direction" name="direction" value="‚Üò inbound">
              <option value="‚Üò inbound"> inbound ‚ÜôÔ∏è</option>
              <option value="outbound ‚Üó">Outbound ‚ÜóÔ∏è </option>
            </select>
            <select class="input" id="priority" name="priority" value="low üíÅ‚Äç‚ôÇÔ∏è">
              <option value="low üíÅ‚Äç‚ôÇÔ∏è">Low üíÅ‚Äç‚ôÇÔ∏è</option>
              <option value="medium ü§ô">Medium ü§ô</option>
              <option value="High‚ùó">High ‚ùó</option>
              <option value="Urgent ‚ö†Ô∏è‚ùó">Urgent ‚ö†Ô∏è‚ùó</option>
            </select>
          </div>

          <br>
          <div>

            <Select id="CSA" class="input blackTxt animate__animated animate__bounceInLeft" name="CSA" type="text">
              <option value=""> Agent üéß</option>
              <option value="Jacob">Jacob</option>
              <option value="Nicky">Nicky</option>
              <option value="Mateo">Mateo</option>
              <option value="Simon">Simon</option>
              <option value="Robert">Robert</option>
              <option value="Bryan">Bryan</option>
              <option value="Diana">Diana</option>
              <option value="James">James</option>
              <option value="Natally">Natally</option>
              <option value="Adriana">Adriana</option>
              <option value="Lina">Lina</option>
              <option value="Angela">Angela</option>
              <option value="Carina">Carina</option>

            </Select>
            <!-- //depending on the type of the call the other options may guide to a diffrent resolution  -->
            <select class="input" id="Type" name="Type">
              <option value="">Category üìä </option>
              <option value="üîç Suspicious Order Verification">Suspicious Order Verification üîç</option>
              <option value="üöö Delivery">Delivery üöö</option>
              <option value="üè• Insurance Coverage Inquiry">Insurance Coverage Inquiry üè•</option>
              <option value="üêõ Scammers">Scammers üêõ</option>
              <option value="üè∑Ô∏è Solicitors">Solicitors üè∑Ô∏è</option>
              <option value="üí∏ Sales">Sales üí∏</option>
              <option value="üõ°Ô∏è Warranty">Warranty üõ°Ô∏è</option>
              <option value="üí∞ Phone Purchase">Phone Purchase üí∞</option>
              <option value="üìù Online Purchase">Online Purchaseüìù</option>
              <option value="üßæ quoteRequest">Quote Request üßæ</option>
              <option value="üò≠ grievance">Grievanceüò≠</option>
              <option value="üîÑ Order Update">Order Update üîÑ</option>
              <option value="‚ùå Error / Silent Call">Error / Silent Call ‚ùå</option>
              <option value="‚ùì General Questions">General Question ‚ùì</option>
              <option value="üè¶ Accouting / Carina">Accouting / Carina üè¶ </option>
            </select>
          </div>
        </section>
        <aside>
          <div>
            <label for="notes">Reason üí≠ </label>
            <input class="animate__animated animate__bounceInLeft input" type="text" name="reason"
              placeholder="Enter Reason for Call">
            <label for="text">Phone üìû</label>
            <input class=" animate__animated animate__bounceInLeft input" type="text" name="cPhone"
              placeholder="Phone # ">
            <label for="text">Email üìß </label>
            <input class="animate__animated animate__bounceInLeft input" type="text" name="cEmail"
              placeholder="Email Address">
            <label for="text">Invoice üìá</label>
            <input class="animate__animated animate__bounceInLeft input" type="text" name="invoice"
              placeholder="Invoice # ">

          </div>
          <div>
            <label for="text">Name ‚úçÔ∏è</label>
            <input id="cName" class="input animate__animated animate__bounceInRight" type="text" name="cName"
              placeholder="Enter Caller's Name">
            <label for="issue">Issue ‚ùå</label>
            <textarea class="input animate__animated animate__bounceInRight" name="issue" rows="2"></textarea>

            <label for="resolution">Resolution or Verbal Agreement ü§ù</label>
            <textarea class="input animate__animated animate__bounceInRight" name="resolution" rows="2"></textarea>
            <!-- <label for="notes">Call Notes üìã</label>
                                <textarea class="input animate__animated animate__bounceInLeft" name="notes"
                                    rows="2"></textarea> -->
          </div>



        </aside>
        <hr>
      </section>
      <!-- <hr>
            <aside class="evidence animate__animated animate__bounceInLeft">
                <div>
                    <label class="evidenceBtn" for="file">Upload and
                        Evidence</label>
                    <input type="file" id="file" name="file">
                </div>
            </aside> -->


      <aside class="input bottom animate__animated animate__bounceInLeft">
        <label class="blackTxt"><input class="assigneeChkBx" type="checkbox" name="assignee" value=""> This call
          is being assigned to a different agent </label><br>
        <div class="hide splitH" id="assigneeContainer">

          <Select class="input  animate__animated animate__bounceInRight" name="assignee" type="text">
            <option value="">Agent Assigned to This Issue</option>
            <option value="Assigned to Hector">Assigned to Hector</option>
            <option value="Assigned to Jacob">Assigned to Jacob</option>
            <option value="Assigned to Mateo">Assigned to Mateo</option>
            <option value="Assigned to Robert">Assigned to Robert</option>
            <option value="Assigned to Bryan">Assigned to Bryan</option>
            <option value="Assigned to Diana">Assigned to Diana</option>
            <option value="Assigned to James">Assigned to James </option>
            <option value="Assigned to Simon">Assigned to Simon</option>
            <option value="Assigned to Natally">Assigned to Natally</option>
            <option value="Assigned to Adriana">Assigned to Adriana</option>
            <option value="Assigned to Lina">Assigned to Lina</option>
            <option value="Assigned to Angela">Assigned to Angela</option>
            <option value="Assigned to Carina">Assigned to Carina</option>
            <option value="Assigned to Nicky">Assigned to Nicky</option>

          </Select>


        </div>
      </aside>

      <aside id="templateHider" class="hide input ">
        <label class="blackTxt"><input class="template" type="checkbox" name="template" value=""> Send Email to
          Customer </label><br>
        <div class="hide splitH" id="templateContainer">

          <Select id="template" name="template" class="input  animate__animated animate__bounceInRight" name="template"
            type="text">
          </Select>


        </div>
      </aside>

      <div class="btnContainer">

        <hr>
        <button id="wrapUpCall" class="btn" type="submit"> Wrap Up Call </button>
      </div>

    </form>


  </section>
  <section class="rightColumn">

    <div class="container">
      <div class="form-card">
        <h1>üìû Retrieve Customer Data Using Invoice</h1>
        <p class="subtitle">Enter an invoice number to retrieve associated invoices, trips, and call logs from
          n8n</p>

        <form id="dataForm">
          <div class="form-group">
            <label for="invoiceNumber">Invoice Number</label>
            <input type="text" id="invoiceNumber" name="invoiceNumber" placeholder="e.g., INV-2025-001" required>
          </div>

          <button type="submit" class="btn" id="submitBtn">
            üîç Retrieve Data
          </button>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Fetching data from n8n...</p>
        </div>

        <div class="error" id="error"></div>
      </div>

      <div class="results" id="results">


        <div class="data-section">
          <div class="section-header">
            <h2 class="section-title">üìÑ Invoice Items</h2>
            <span class="badge" id="invoicesBadge">0</span>
          </div>
          <div id="invoicesContent"></div>
        </div>

        <div class="data-section">
          <div class="section-header">
            <h2 class="section-title">üöö Trips Scheduled </h2>
            <span class="badge" id="tripsBadge">0</span>
          </div>
          <div id="tripsContent"></div>
        </div>

        <div class="data-section">
          <div class="section-header">
            <h2 class="section-title">‚òéÔ∏è Call Logged </h2>
            <span class="badge" id="callsBadge">0</span>
          </div>
          <div id="callsContent"></div>
        </div>
      </div>
    </div>
    <footer>
      <small>Please provide Feedback @ Tech@cevimed.com</small>
    </footer>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script>
    // ‚ö†Ô∏è IMPORTANT: Replace this with your actual n8n webhook URL
    const WEBHOOK_URL = 'https://n8n.cevispace.com/webhook/d8b9bced-6334-4911-92b3-176f7cc7072d';
    const form = document.getElementById('dataForm');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const error = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

      // Reset UI
      error.classList.remove('active');
      results.classList.remove('active');
      loading.classList.add('active');
      submitBtn.disabled = true;

      try {
        // Make POST request to n8n webhook
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            invoice: invoiceNumber
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();



        // Display the data
        displayData(data);

      } catch (err) {
        console.error('Error:', err);
        error.textContent = `Error: ${err.message}. Please check the webhook URL and try again.`;
        error.classList.add('active');
      } finally {
        loading.classList.remove('active');
        submitBtn.disabled = false;
      }
    });

    function displayData(data) {
      //Order : invoice , trips, calls
      let dataArray = Object.values(data[0])
      let fullArray = Object.entries(data[0]).map(l => [Object.keys(l), Object.values(l)].flat())


      fullArray.forEach(l => {
        console.log(l)

        displaySection(Object.values(l[3]), `${l[2]}Content`, `${l[2]}Badge`, `No ${l[2]} Registered yet`, `${l[3]["records"].length}`, `${l[2]}`)
      })
      // Show results
      results.classList.add('active');
    }

    function displaySection(items, contentId, badgeId, emptyMessage, totalItems, type) {
      const content = document.getElementById(contentId);
      const badge = document.getElementById(badgeId);
      // Update badge
      badge.textContent = totalItems;
      badge.classList.toggle('empty', items.length === 0);

      // Display items
      if (items.length === 0) {
        content.innerHTML = `<div class="no-data">${emptyMessage}</div>`;
        return;
      }

      content.innerHTML = items.map((item, index) => {
        console.log(Object.entries(item))
        const formatDate = s => {
  // Extract MM/DD/YYYY safely
  const [m, dNum, y] = s.split("/").map(Number);

  // FIX: create date without timezone shift
  const d = new Date(y, m - 1, dNum);

  const day = d.getDate();
  const suf = (n =>
    (n % 10 == 1 && n != 11 ? "st" :
     n % 10 == 2 && n != 12 ? "nd" :
     n % 10 == 3 && n != 13 ? "rd" : "th")
  )(day);

  return d
    .toLocaleDateString("en-US", {
      weekday: "long",
      month: "long",
      day: "numeric",
      year: "numeric"
    })
    .replace(",", "")
    .replace(day, day + suf);
};

        
        const renderOrderCard = (order, i) => `
<div class="orderCard-container">
  <div class="orderCard-card">

    <h2 class="orderCard-title">Order #${order["Order #"] || order.Name}</h2>

    <div class="orderCard-section">
      <h3>Customer Info</h3>
      <div class="orderCard-grid">
        <div><strong>Name:</strong> ${order.Customer}</div>
        <div><strong>Email:</strong> ${order.Email}</div>
        <div><strong>Phone:</strong> ${order.Phone}</div>
      </div>
    </div>

    <div class="orderCard-section">
      <h3>Order Details</h3>
      <div class="orderCard-grid">
        <div><strong>Item:</strong> ${order.Item?.split("Choose Color")[0]}</div>
        <div><strong>Color:</strong> ${order.Item?.match(/Choose Color:(.*)/)?.[1] || "‚Äî"}</div>
        <div><strong>Qty:</strong> ${order.QTY}</div>
        <div><strong>EA Price:</strong> $${order["EA Price"]}</div>
        <div><strong>Shipping:</strong> $${order.Shipping}</div>
        <div><strong>Total Amount:</strong> $${order["Total Amount"]}</div>
        <div><strong>Profit:</strong> $${order.Profit}</div>
        <div><strong>Category:</strong> ${order.Category?.join(", ")}</div>
        <div><strong>Type:</strong> ${order["Type of Product"]}</div>
      </div>

      <p class="orderCard-multiline"><strong>Item Notes:</strong><br>
        ${order.Item?.replace(/\n/g, "<br>")}
      </p>
    </div>

    <div class="orderCard-section">
      <h3>Shipping Address</h3>
      <p class="orderCard-multiline">
        ${order["Address "]?.replace(/\n/g, "<br>")}
      </p>
    </div>

    ${order.Attachment?.length
            ? `
        <div class="orderCard-section">
          <h3>Attachments</h3>
          <div class="orderCard-images">
            ${order.Attachment.map(a => `
              <img src="${a.url}" alt="${a.filename}" />
            `).join("")}
          </div>
        </div>
      `
            : ""}

    ${order.POD?.length
            ? `
        <div class="orderCard-section">
          <h3>POD Images</h3>
          <div class="orderCard-images">
            ${order.POD.map(a => `
              <img src="${a.url}" alt="${a.filename}" />
            `).join("")}
          </div>
        </div>
      `
            : ""}

  </div>
</div>
`;
        const renderTripsCard = (trip) => `
<div class="orderCard-container">
  <div class="orderCard-card">

    <h2 class="orderCard-title">Trip ‚Äì ${trip.Trips || trip.Name}</h2>

    <!-- CUSTOMER / CONTACT INFO -->
    <div class="orderCard-section">
      <h3>Customer Info</h3>
      <div class="orderCard-grid">
        <div><strong>Name:</strong> ${trip.Name}</div>
        <div><strong>Email:</strong> ${trip.email}</div>
        <div><strong>Phone:</strong> ${trip.Phone}</div>
        <div><strong>Address:</strong> ${trip.Address}</div>
        <div><strong>State:</strong> ${trip.State}</div>
      </div>
    </div>

    <!-- TRIP DETAILS -->
    <div class="orderCard-section">
      <h3>Trip Details</h3>
      <div class="orderCard-grid">
        <div><strong>Route:</strong> ${trip.Route}</div>
        <div><strong>Driver:</strong> ${trip["Driver Name"]?.join(", ")}</div>
        <div><strong>Position #:</strong> ${trip["Position #"]}</div>
        <div><strong>Position Truck:</strong> ${trip["Position Truck"]?.join(", ")}</div>
        <div><strong>Stops:</strong> ${trip["Stop actual"]} / ${trip["Total of stops"]}</div>
        <div><strong>Date of Trip:</strong> ${trip["Date of Trip"]}</div>
        <div><strong>Invoice Date:</strong> ${trip["Invoice Date"]}</div>
        <div><strong>Invoice Lookup:</strong> ${trip["Invoice Lookup"]}</div>
        <div><strong>Days Since Invoice:</strong> ${trip["Days of Invoice"]}</div>
        <div><strong>Status:</strong> ${trip.Status}</div>
        <div><strong>Payment Status:</strong> ${trip["Payment Status"]?.join(", ")}</div>
        <div><strong>Category:</strong> ${trip.Category?.join(", ")}</div>
        <div><strong>Type of Product:</strong> ${trip["Type of Product"]}</div>
      </div>

      <p class="orderCard-multiline">
        <strong>Description:</strong><br>
        ${trip.Description?.replace(/\n/g, "<br>")}
      </p>
    </div>

    <!-- SAMSARA LINKS -->
    <div class="orderCard-section">
      <h3>Samsara</h3>
      <div class="orderCard-grid">
        <div><strong>Samsara Link:</strong> 
          <a href="${trip["Samsara Link"]}" target="_blank">Open Link</a>
        </div>
      </div>
    </div>

    <!-- MAPPING -->
    ${trip["Samsura Map"]?.length ? `
      <div class="orderCard-section">
        <h3>Samsara Map</h3>
        <div class="orderCard-images">
          ${trip["Samsura Map"].map(m => `
            <img src="${m.url}" alt="${m.filename}" />
          `).join("")}
        </div>
      </div>
    ` : ""}

    <!-- ATTACHMENTS -->
    ${trip.Attachments?.length ? `
      <div class="orderCard-section">
        <h3>Attachments</h3>
        <div class="orderCard-images">
          ${trip.Attachments.map(a => `
            <img src="${a.url}" alt="${a.filename}" />
          `).join("")}
        </div>
      </div>
    ` : ""}

  </div>
</div>
`;
        function renderCallCard(call) {
          console.log(type)
          const priorityColor = {
            "low üíÅ‚Äç‚ôÇÔ∏è": 'rgba(245, 251, 85, 0.2)',        // transparent yellow
            "medium ü§ô": 'rgba(255, 159, 41,0.2)',       // transparent orange
            "high‚ùó": 'rgba(255, 95, 32,0.2)',           // transparent red
            "urgent ‚ö†Ô∏è‚ùó": 'rgba(230, 39, 39,0.25)'          // darker red
          };

          const bgColor = priorityColor[call.priority?.toLowerCase()] || 'rgba(0,0,0,0.05)';
          console.log(call.priority.toLowerCase(), bgColor)
          return `
          <div class="orderCard-container">
            <div style="background:${bgColor};" class="orderCard-card">

              <h2 class="orderCard-title">Call by ${call["Caller Name"]} on  ${formatDate(new Date(call.createdTime).toLocaleString().split(",")[0])}</h2>

              <!-- CUSTOMER / CALL INFO -->
              <div class="orderCard-section">
                <h3>Call Info</h3>
                <div class="orderCard-grid">
                  <div><strong>CS Agent:</strong> ${call["CS Agent"]}</div>
                  <div><strong>Call Direction:</strong> ${call["Call Direction"]}</div>
                  <div><strong>Caller Name:</strong> ${call["Caller Name"]}</div>
                  <div><strong>Phone #:</strong> ${call["Phone #"]}</div>
                  <div><strong>Type of Call:</strong> ${call["Type of Call "]}</div>
                  <div><strong>Priority:</strong> ${call.priority}</div>
                  <div><strong>Timestamp:</strong> ${call["time stamp"]}</div>
                </div>
              </div>

              <!-- INVOICE INFO -->
              <div class="orderCard-section">
                <h3>Invoice Details</h3>
                <div class="orderCard-grid">
                  <div><strong>Invoice Lookup:</strong> ${call["Invoice Lookup "]}</div>
                  <div><strong>Invoices:</strong> ${call.Invoices?.join(", ")}</div>
                  <div><strong>Name (from Invoices):</strong> ${call["Name (from Invoices)"]?.join(", ")}</div>
                  <div><strong>Invoice #:</strong> ${call["invoice #"]}</div>
                </div>
              </div>

              <!-- ISSUE -->
              <div class="orderCard-section">
                <h3>Issue Reported</h3>
                <p class="orderCard-multiline">
                  <strong>Issue:</strong><br>
                  ${call.Issue}
                </p>
              </div>

            </div>
          </div>

  `;
        } const executeCard = (type) => {


          switch (type) {
            case "calls":
              return rows.map(item => renderCallCard(item, index))
              break;

            case "trips":
              return rows.map(item => renderTripsCard(item, index))
              break;

            case "invoices":
              return rows.map(item => renderOrderCard(item, index))
              break;

            default:
              console.warn("Unknown type:", type);
          }
        }
        const rows = Object.values(item)


        return `
                    <div class="data-item">
                        ${executeCard(type)}
                    </div>
                `;
      }).join('');
    }

    function formatFieldName(name) {
      // Convert camelCase or snake_case to Title Case
      return name
        .replace(/([A-Z])/g, ' $1')
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase())
        .trim();
    }
  </script>
  <script type="module" src="./assets/script.js"></script>
</body>

</html>