<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="icon" type="image/x-icon" href="./assets/img/icon.svg
    ">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <title>CeviMed Customer Service Form</title>
</head>

<body>
    <section class="leftColumn">
        <img src="./assets/img/column.jpg" alt="">
    </section>
    <section id="formContainer">
        <img id="logo" src="./assets/img/logo.png" alt="">
        <form target="_blank"
            action="https://hooks.airtable.com/workflows/v1/genericWebhook/app7xwRPHHOaWI4pJ/wflyLNHGL2T8dEnQs/wtrlCTYJiBKLmDcAZ"
            method="post" onkeydown="(event.keyCode === 13) && false">
            <section id="fields">
                <section id="flags" class="animate__animated animate__bounceInLeft">

                    <div>

                        <select class="input" id="direction" name="direction" value="â†˜ inbound">
                            <option value="â†˜ inbound"> inbound â†™ï¸</option>
                            <option value="outbound â†—">Outbound â†—ï¸ </option>
                        </select>
                        <select class="input" id="priority" name="priority" value="low ğŸ’â€â™‚ï¸">
                            <option value="low ğŸ’â€â™‚ï¸">Low ğŸ’â€â™‚ï¸</option>
                            <option value="medium ğŸ¤™">Medium ğŸ¤™</option>
                            <option value="Highâ—">High â—</option>
                            <option value="Urgent âš ï¸â—">Urgent âš ï¸â—</option>
                        </select>
                    </div>

                    <br>
                    <div>

                        <Select id="CSA" class="input blackTxt animate__animated animate__bounceInLeft" name="CSA"
                            type="text">
                            <option value=""> Agent ğŸ§</option>
                            <option value="Jacob">Jacob</option>
                            <option value="Nicky">Nicky</option>
                            <option value="Mateo">Mateo</option>
                            <option value="Simon">Simon</option>
                            <option value="Robert">Robert</option>
                            <option value="Bryan">Bryan</option>
                            <option value="Diana">Diana</option>
                            <option value="James">James</option>
                            <option value="Natally">Natally</option>
                            <option value="Adriana">Adriana</option>
                            <option value="Lina">Lina</option>
                            <option value="Angela">Angela</option>
                            <option value="Carina">Carina</option>

                        </Select>
                        <!-- //depending on the type of the call the other options may guide to a diffrent resolution  -->
                        <select class="input" id="Type" name="Type">
                            <option value="">Category ğŸ“Š </option>
                            <option value="ğŸ” Suspicious Order Verification">Suspicious Order Verification ğŸ”</option>
                            <option value="ğŸšš Delivery">Delivery ğŸšš</option>
                            <option value="ğŸ¥ Insurance Coverage Inquiry">Insurance Coverage Inquiry ğŸ¥</option>
                            <option value="ğŸ› Scammers">Scammers ğŸ›</option>
                            <option value="ğŸ·ï¸ Solicitors">Solicitors ğŸ·ï¸</option>
                            <option value="ğŸ’¸ Sales">Sales ğŸ’¸</option>
                            <option value="ğŸ›¡ï¸ Warranty">Warranty ğŸ›¡ï¸</option>
                            <option value="ğŸ’° Phone Purchase">Phone Purchase ğŸ’°</option>
                            <option value="ğŸ“ Online Purchase">Online PurchaseğŸ“</option>
                            <option value="ğŸ§¾ quoteRequest">Quote Request ğŸ§¾</option>
                            <option value="ğŸ˜­ grievance">GrievanceğŸ˜­</option>
                            <option value="ğŸ”„ Order Update">Order Update ğŸ”„</option>
                            <option value="âŒ Error / Silent Call">Error / Silent Call âŒ</option>
                            <option value="â“ General Questions">General Question â“</option>
                            <option value="ğŸ¦ Accouting / Carina">Accouting / Carina ğŸ¦ </option>
                        </select>
                    </div>
                </section>
                <aside>
                    <div>
                        <label for="notes">Reason ğŸ’­ </label>
                        <input class="animate__animated animate__bounceInLeft input" type="text" name="reason"
                            placeholder="Enter Reason for Call">
                        <label for="text">Phone ğŸ“</label>
                        <input class=" animate__animated animate__bounceInLeft input" type="text" name="cPhone"
                            placeholder="Phone # ">
                        <label for="text">Email ğŸ“§ </label>
                        <input class="animate__animated animate__bounceInLeft input" type="text" name="cEmail"
                            placeholder="Email Address">
                        <label for="text">Invoice ğŸ“‡</label>
                        <input class="animate__animated animate__bounceInLeft input" type="text" name="invoice"
                            placeholder="Invoice # ">

                    </div>
                    <div>
                        <label for="text">Name âœï¸</label>
                        <input id="cName" class="input animate__animated animate__bounceInRight" type="text"
                            name="cName" placeholder="Enter Caller's Name">
                        <label for="issue">Issue âŒ</label>
                        <textarea class="input animate__animated animate__bounceInRight" name="issue"
                            rows="2"></textarea>

                        <label for="resolution">Resolution or Verbal Agreement ğŸ¤</label>
                        <textarea class="input animate__animated animate__bounceInRight" name="resolution"
                            rows="2"></textarea>
                        <!-- <label for="notes">Call Notes ğŸ“‹</label>
                                <textarea class="input animate__animated animate__bounceInLeft" name="notes"
                                    rows="2"></textarea> -->
                    </div>



                </aside>
                <hr>
            </section>
            <!-- <hr>
            <aside class="evidence animate__animated animate__bounceInLeft">
                <div>
                    <label class="evidenceBtn" for="file">Upload and
                        Evidence</label>
                    <input type="file" id="file" name="file">
                </div>
            </aside> -->


            <aside class="input bottom animate__animated animate__bounceInLeft">
                <label class="blackTxt"><input class="assigneeChkBx" type="checkbox" name="assignee" value=""> This call
                    is being assigned to a different agent </label><br>
                <div class="hide splitH" id="assigneeContainer">

                    <Select class="input  animate__animated animate__bounceInRight" name="assignee" type="text">
                        <option value="">Agent Assigned to This Issue</option>
                        <option value="Assigned to Hector">Assigned to Hector</option>
                        <option value="Assigned to Jacob">Assigned to Jacob</option>
                        <option value="Assigned to Mateo">Assigned to Mateo</option>
                        <option value="Assigned to Robert">Assigned to Robert</option>
                        <option value="Assigned to Bryan">Assigned to Bryan</option>
                        <option value="Assigned to Diana">Assigned to Diana</option>
                        <option value="Assigned to James">Assigned to James </option>
                        <option value="Assigned to Simon">Assigned to Simon</option>
                        <option value="Assigned to Natally">Assigned to Natally</option>
                        <option value="Assigned to Adriana">Assigned to Adriana</option>
                        <option value="Assigned to Lina">Assigned to Lina</option>
                        <option value="Assigned to Angela">Assigned to Angela</option>
                        <option value="Assigned to Carina">Assigned to Carina</option>
                        <option value="Assigned to Nicky">Assigned to Nicky</option>

                    </Select>


                </div>
            </aside>

            <aside id="templateHider" class="hide input ">
                <label class="blackTxt"><input class="template" type="checkbox" name="template" value=""> Send Email to
                    Customer </label><br>
                <div class="hide splitH" id="templateContainer">

                    <Select id="template" name="template" class="input  animate__animated animate__bounceInRight"
                        name="template" type="text">
                    </Select>


                </div>
            </aside>

            <div class="btnContainer">

                <hr>
                <button id="wrapUpCall" class="btn" type="submit"> Wrap Up Call </button>
            </div>

        </form>


    </section>
    <section class="rightColumn">

        <div class="container">
            <div class="form-card">
                <h1>ğŸ“ Retrieve Customer Data Using Invoice</h1>
                <p class="subtitle">Enter an invoice number to retrieve associated invoices, trips, and call logs from
                    n8n</p>

                <form id="dataForm">
                    <div class="form-group">
                        <label for="invoiceNumber">Invoice Number</label>
                        <input type="text" id="invoiceNumber" name="invoiceNumber" placeholder="e.g., INV-2025-001"
                            required>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">
                        ğŸ” Retrieve Data
                    </button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Fetching data from n8n...</p>
                </div>

                <div class="error" id="error"></div>
            </div>

            <div class="results" id="results">
              

                <div class="data-section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸ“„ Invoices</h2>
                        <span class="badge" id="invoicesBadge">0</span>
                    </div>
                    <div id="invoicesContent"></div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸšš Trips</h2>
                        <span class="badge" id="tripsBadge">0</span>
                    </div>
                    <div id="tripsContent"></div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸ“ Call Logs</h2>
                        <span class="badge" id="callsBadge">0</span>
                    </div>
                    <div id="callsContent"></div>
                </div>
            </div>
        </div>
        <footer>
            <small>Please provide Feedback @ Tech@cevimed.com</small>
        </footer>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // âš ï¸ IMPORTANT: Replace this with your actual n8n webhook URL
        const WEBHOOK_URL = 'https://n8n.cevispace.com/webhook/d8b9bced-6334-4911-92b3-176f7cc7072d';
        const form = document.getElementById('dataForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            // Reset UI
            error.classList.remove('active');
            results.classList.remove('active');
            loading.classList.add('active');
            submitBtn.disabled = true;

            try {
                // Make POST request to n8n webhook
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoice: invoiceNumber
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();


                // Display the data
                displayData(data);

            } catch (err) {
                console.error('Error:', err);
                error.textContent = `Error: ${err.message}. Please check the webhook URL and try again.`;
                error.classList.add('active');
            } finally {
                loading.classList.remove('active');
                submitBtn.disabled = false;
            }
        });

        function displayData(data) {
            //Order : invoice , trips, calls
            let dataArray = Object.values(data[0])
            let fullArray = Object.entries(data[0]).map(l => [Object.keys(l), Object.values(l)].flat())

        

            fullArray.forEach(l => {
                console.log(l)

                displaySection(Object.values(l[3]), `${l[2]}Content`, `${l[2]}Badge`, `No ${l[2]} Registered yet`)
            })
            // Show results
            results.classList.add('active');
        }

        function displaySection(items, contentId, badgeId, emptyMessage) {

            const content = document.getElementById(contentId);
            const badge = document.getElementById(badgeId);
            // Update badge
            badge.textContent = items.length;
            badge.classList.toggle('empty', items.length === 0);

            // Display items
            if (items.length === 0) {
                content.innerHTML = `<div class="no-data">${emptyMessage}</div>`;
                return;
            }

            content.innerHTML = items.map((item, index) => {
                console.log(Object.values(item))
                const renderOrderCard = (order) => `
<div class="orderCard-container">
  <div class="orderCard-card">

    <h2 class="orderCard-title">Order #${order["Order #"] || order.Name}</h2>

    <div class="orderCard-section">
      <h3>Customer Info</h3>
      <div class="orderCard-grid">
        <div><strong>Name:</strong> ${order.Customer}</div>
        <div><strong>Email:</strong> ${order.Email}</div>
        <div><strong>Phone:</strong> ${order.Phone}</div>
      </div>
    </div>

    <div class="orderCard-section">
      <h3>Order Details</h3>
      <div class="orderCard-grid">
        <div><strong>Item:</strong> ${order.Item?.split("Choose Color")[0]}</div>
        <div><strong>Color:</strong> ${order.Item?.match(/Choose Color:(.*)/)?.[1] || "â€”"}</div>
        <div><strong>Qty:</strong> ${order.QTY}</div>
        <div><strong>EA Price:</strong> $${order["EA Price"]}</div>
        <div><strong>Shipping:</strong> $${order.Shipping}</div>
        <div><strong>Total Amount:</strong> $${order["Total Amount"]}</div>
        <div><strong>Profit:</strong> $${order.Profit}</div>
        <div><strong>Category:</strong> ${order.Category?.join(", ")}</div>
        <div><strong>Type:</strong> ${order["Type of Product"]}</div>
      </div>

      <p class="orderCard-multiline"><strong>Item Notes:</strong><br>
        ${order.Item?.replace(/\n/g, "<br>")}
      </p>
    </div>

    <div class="orderCard-section">
      <h3>Shipping Address</h3>
      <p class="orderCard-multiline">
        ${order["Address "]?.replace(/\n/g, "<br>")}
      </p>
    </div>

    ${order.Attachment?.length
                        ? `
        <div class="orderCard-section">
          <h3>Attachments</h3>
          <div class="orderCard-images">
            ${order.Attachment.map(a => `
              <img src="${a.url}" alt="${a.filename}" />
            `).join("")}
          </div>
        </div>
      `
                        : ""}

    ${order.POD?.length
                        ? `
        <div class="orderCard-section">
          <h3>POD Images</h3>
          <div class="orderCard-images">
            ${order.POD.map(a => `
              <img src="${a.url}" alt="${a.filename}" />
            `).join("")}
          </div>
        </div>
      `
                        : ""}

  </div>
</div>
`;

                const rows = Object.values(item)
             

                return `
                    <div class="data-item">
                        <strong style="color: #667eea; margin-bottom: 10px; display: block;">
                            Record ${index}
                        </strong>
                        ${rows.map(item => renderOrderCard(item))}
                    </div>
                `;
            }).join('');
        }

        function formatFieldName(name) {
            // Convert camelCase or snake_case to Title Case
            return name
                .replace(/([A-Z])/g, ' $1')
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .trim();
        }
    </script>
    <script type="module" src="./assets/script.js"></script>
</body>

</html>